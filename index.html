<!DOCTYPE html>
<html lang="en" class="light"> <!-- Default to light, script will check localStorage -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator Pro</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/masisparmo/qrcodegenerator/refs/heads/main/favicon.ico" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- QR Code Styling Library -->
    <script src="https://unpkg.com/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Skrip anti-FOUC (Flash of Unstyled Content) untuk Mode Gelap
        // Dijalankan sebelum rendering untuk mencegah kedipan
        (function() {
            try {
                const theme = localStorage.getItem('theme');
                if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.remove('light');
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                }
            } catch (_) {}
        })();
    </script>
    
    <script>
        // Konfigurasi Tailwind untuk mode gelap
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    
    <style>
        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        /* Perbaikan style untuk dropdown di mode gelap */
        .dark select option {
            background: #1f2937; /* Latar belakang dark (gray-800) */
            color: #f3f4f6; /* Teks light (gray-100) */
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 font-inter antialiased text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">

    <!-- Header -->
    <header id="generator-header" class="sticky top-0 z-50 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center min-h-16 py-3">
                <!-- Logo dan Judul -->
                <div class="flex items-center gap-3">
                    <img src="https://raw.githubusercontent.com/masisparmo/qrcodegenerator/refs/heads/main/qrcodegenerator-logo.png" alt="Logo" class="w-10 h-10 rounded-md object-cover">
                    <div class="flex flex-col">
                        <h1 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white" data-lang="title">QR Code Generator Pro</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400 -mt-1" data-lang="subtitle">Free QR Code Generator PRO Multi Function</p>
                    </div>
                </div>
                
                <!-- Tombol Kontrol -->
                <div class="flex items-center space-x-3 sm:space-x-4">
                    <button id="history-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" title="My Codes">
                        <i data-lucide="archive" class="w-5 h-5"></i>
                    </button>
                    <button id="lang-toggle-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" title="Toggle Language">
                        <span class="text-sm font-medium">EN</span>
                    </button>
                    <button id="theme-toggle-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" title="Toggle Theme">
                        <i data-lucide="sun" class="w-5 h-5" id="theme-icon-sun"></i>
                        <i data-lucide="moon" class="w-5 h-5 hidden" id="theme-icon-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Konten Utama Generator -->
    <main id="generator-main" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Kolom 1: Tipe QR dan Input Data -->
            <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-4" data-lang="col1Title">1. Select QR Code Type</h2>
                
                <!-- Tab Tipe QR -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-6">
                    <button id="tab-single" class="tab-btn flex flex-col items-center justify-center p-3 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="link" class="w-6 h-6 mb-1"></i>
                        <span class="text-sm font-medium" data-lang="tabSingle">Single URL</span>
                    </button>
                    <button id="tab-multi" class="tab-btn flex flex-col items-center justify-center p-3 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="list" class="w-6 h-6 mb-1"></i>
                        <span class="text-sm font-medium" data-lang="tabMulti">Multi URL</span>
                    </button>
                    <button id="tab-vcard" class="tab-btn flex flex-col items-center justify-center p-3 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="contact" class="w-6 h-6 mb-1"></i>
                        <span class="text-sm font-medium" data-lang="tabVcard">vCard</span>
                    </button>
                    <button id="tab-whatsapp" class="tab-btn flex flex-col items-center justify-center p-3 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="message-circle" class="w-6 h-6 mb-1"></i>
                        <span class="text-sm font-medium" data-lang="tabWhatsapp">WhatsApp</span>
                    </button>
                </div>

                <!-- Panel Input -->
                <div class="space-y-6">
                    
                    <!-- Panel Single URL -->
                    <div id="panel-single" class="tab-panel">
                        <label for="single-url" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="singleUrlLabel">Enter Your Website URL</label>
                        <input type="text" id="single-url" data-lang-placeholder="singleUrlPlaceholder" placeholder="https://www.your-website.com" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Panel Multi URL -->
                    <div id="panel-multi" class="tab-panel" style="display: none;">
                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300" data-lang="multiUrlTitle">Page Title</h3>
                        <input type="text" id="multi-title" data-lang-placeholder="multiUrlTitlePlaceholder" placeholder="My Links Page" class="mt-1 mb-4 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">

                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300" data-lang="multiUrlLinks">Links</h3>
                        <div id="multi-links-container" class="space-y-3 mt-2">
                            <!-- Link dinamis akan ditambahkan di sini -->
                        </div>
                        <div class="flex items-center gap-4 mt-4">
                            <button id="multi-add-link" class="flex items-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-lang="multiUrlAddLink">Add Link</span>
                            </button>
                            <button id="multi-preview-btn" class="flex items-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                <span data-lang="preview">Preview</span>
                            </button>
                        </div>
                    </div>

                    <!-- Panel vCard -->
                    <div id="panel-vcard" class="tab-panel" style="display: none;">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="vcard-first-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardFirstName">First Name</label>
                                <input type="text" id="vcard-first-name" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-last-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardLastName">Last Name</label>
                                <input type="text" id="vcard-last-name" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardPhone">Phone</label>
                                <input type="tel" id="vcard-phone" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardEmail">Email</label>
                                <input type="email" id="vcard-email" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-company" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardCompany">Company</label>
                                <input type="text" id="vcard-company" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardTitle">Job Title</label>
                                <input type="text" id="vcard-title" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="sm:col-span-2">
                                <label for="vcard-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardNote">Note</label>
                                <textarea id="vcard-note" rows="2" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                        </div>

                        <!-- Social Media Links -->
                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300 mt-6 mb-2" data-lang="vcardSocials">Social Media</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="vcard-social-facebook" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardSocialFacebook">Facebook (Username or URL)</label>
                                <input type="text" id="vcard-social-facebook" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-social-instagram" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardSocialInstagram">Instagram (Username or URL)</label>
                                <input type="text" id="vcard-social-instagram" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-social-tiktok" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardSocialTikTok">TikTok (Username or URL)</label>
                                <input type="text" id="vcard-social-tiktok" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-social-linkedin" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardSocialLinkedIn">LinkedIn (Username or URL)</label>
                                <input type="text" id="vcard-social-linkedin" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="vcard-social-x" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="vcardSocialX">X / Twitter (Username or URL)</label>
                                <input type="text" id="vcard-social-x" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div id="vcard-socials-container" class="space-y-3 mt-3">
                            <!-- Custom socials di sini -->
                        </div>
                        <button id="vcard-add-social" class="mt-4 flex items-center gap-2 px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span data-lang="vcardAddSocial">Add Other Social</span>
                        </button>
                        
                        <!-- Custom Fields -->
                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300 mt-6 mb-2" data-lang="vcardCustom">Custom Fields</h3>
                        <div id="vcard-fields-container" class="space-y-3">
                            <!-- Custom fields di sini -->
                        </div>
                        <button id="vcard-add-field" class="mt-4 flex items-center gap-2 px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span data-lang="vcardAddField">Add Custom Field</span>
                        </button>
                    </div>

                    <!-- Panel WhatsApp -->
                    <div id="panel-whatsapp" class="tab-panel" style="display: none;">
                        <label for="whatsapp-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="whatsappLabel">Enter WhatsApp Number</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1" data-lang="whatsappHint">Will be auto-formatted to a wa.me link.</p>
                        <input type="tel" id="whatsapp-number" data-lang-placeholder="whatsappPlaceholder" placeholder="e.g., +62812345678" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Kolom 2: Kustomisasi Tampilan (di dalam kolom 1) -->
                <h2 class="text-lg font-semibold mt-8 mb-4 border-t border-gray-200 dark:border-gray-700 pt-6" data-lang="col2Title">2. Customize QR Code</h2>
                <div class="space-y-6">
                    <!-- Pilihan Warna -->
                    <div>
                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300" data-lang="styleColors">Colors</h3>
                        <div class="flex flex-wrap gap-x-6 gap-y-4 mt-2">
                            <div class="flex items-center gap-2">
                                <input type="color" id="color-dots" value="#000000" class="w-10 h-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                                <label for="color-dots" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="styleDots">Dots</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="color" id="color-bg" value="#ffffff" class="w-10 h-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                                <label for="color-bg" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="styleBg">Background</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="color" id="color-corner-square" value="#000000" class="w-10 h-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                                <label for="color-corner-square" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="styleCornerSquare">Corner Squares</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="color" id="color-corner-dot" value="#000000" class="w-10 h-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                                <label for="color-corner-dot" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="styleCornerDot">Corner Dots</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pilihan Gaya -->
                    <div>
                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300" data-lang="styleShape">Shape & Style</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="style-dots" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="styleDotsType">Dots Style</label>
                                <select id="style-dots" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="square">Square</option>
                                    <option value="dots">Dots</option>
                                    <option value="rounded">Rounded</option>
                                    <option value="extra-rounded">Extra Rounded</option>
                                    <option value="classy">Classy</option>
                                    <option value="classy-rounded">Classy Rounded</option>
                                </select>
                            </div>
                            <div>
                                <label for="style-corner-square" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="styleCornerSquareType">Corner Square Style</label>
                                <select id="style-corner-square" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="square">Square</option>
                                    <option value="dot">Dot</option>
                                    <option value="extra-rounded">Extra Rounded</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label for="style-corner-dot" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="styleCornerDotType">Corner Dot Style</label>
                                <select id="style-corner-dot" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="square">Square</option>
                                    <option value="dot">Dot</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logo -->
                    <div>
                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300" data-lang="styleLogo">Logo</h3>
                        <div class="flex items-center gap-4 mt-2">
                            <input type="file" id="logo-upload" class="hidden" accept="image/png, image/jpeg, image/svg+xml">
                            <label for="logo-upload" class="flex-1 cursor-pointer px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 truncate" data-lang="styleLogoUpload">
                                Choose image...
                            </label>
                            <button id="logo-remove" class="p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Teks Kustom -->
                    <div>
                        <h3 class="text-md font-medium text-gray-700 dark:text-gray-300" data-lang="styleCustomText">Custom Text</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 -mt-1 mb-2" data-lang="styleCustomTextHint">Appears below the logo (or in center).</p>
                        <div class="flex items-center gap-4">
                            <input type="text" id="custom-text" data-lang-placeholder="styleCustomTextPlaceholder" placeholder="Your Text..." class="flex-1 w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <input type="color" id="custom-text-color" value="#000000" class="w-10 h-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm" title="Text Color">
                            <button id="text-remove" class="p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Kolom 3: Preview dan Download (Sticky) -->
            <div class="lg:col-span-1">
                <div class="sticky top-24 space-y-6"> <!-- top-24 untuk memberi ruang di bawah header sticky (h-16 + py-8) -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                        <h2 class="text-lg font-semibold mb-4" data-lang="col3Title">3. Download QR Code</h2>
                        
                        <!-- Preview QR Code -->
                        <div id="qr-code-preview" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600 flex justify-center items-center mb-6">
                            <!-- QR Code akan di-render di sini -->
                        </div>

                        <!-- Tombol Save -->
                        <button id="save-code-btn" class="w-full flex items-center justify-center gap-2 mb-4 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span data-lang="saveCode">Save Code</span>
                        </button>
                        
                        <!-- Tombol Download -->
                        <div class="grid grid-cols-2 gap-4">
                            <button id="download-png-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                                <i data-lucide="image" class="w-4 h-4"></i>
                                PNG
                            </button>
                            <button id="download-svg-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <i data-lucide="file-code" class="w-4 h-4"></i>
                                SVG
                            </button>
                        </div>

                        <!-- Share Link (Khusus Multi URL) -->
                        <div id="share-link-wrapper" class="mt-6" style="display: none;">
                            <label for="share-link-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="shareLink">Share Link</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="share-link-input" readonly class="flex-1 block w-full px-3 py-2 text-sm rounded-none rounded-l-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-300 focus:outline-none">
                                <button id="copy-link-btn" class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 dark:border-gray-600 rounded-r-md bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                    <span id="copy-link-text" class="ml-2 text-sm font-medium" data-lang="copy">Copy</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- [PERBAIKAN] Halaman Arahan (Landing Page) Multi URL -->
    <div id="landing-page" class="hidden">
        <div class="min-h-screen flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
            <div class="w-full max-w-md mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-6 sm:p-8">
                    <div id="landing-logo-container" class="mb-6 flex justify-center"></div>
                    <h1 id="landing-title" class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6"></h1>
                    <div id="landing-links-container" class="space-y-4">
                        <!-- Tautan dinamis akan ditambahkan di sini -->
                    </div>
                </div>
                <footer class="mt-4 text-center">
                    <a href="/" class="text-xs text-gray-500 dark:text-gray-400 hover:underline" data-lang="footerCreate">Create your own QR Code</a>
                </footer>
            </div>
        </div>
    </div>
    
    <!-- Modal "Preview" -->
    <div id="preview-modal" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold" data-lang="previewTitle">Page Preview</h2>
                <button id="close-preview-modal" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="preview-content" class="p-6 overflow-y-auto">
                <!-- Konten pratinjau akan dimuat di sini -->
            </div>
        </div>
    </div>

    <!-- Modal "My Codes" (History) -->
    <div id="history-modal" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold" id="modal-title" data-lang="myCodes">My Codes</h2>
                <button id="close-history-modal" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div id="history-list" class="p-6 overflow-y-auto space-y-4">
                <!-- History items akan dimuat di sini -->
            </div>
        </div>
    </div>

    <!-- Modal "Save Code" -->
    <div id="save-modal" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden" aria-labelledby="save-modal-title" role="dialog" aria-modal="true">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-sm w-full">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold" id="save-modal-title" data-lang="saveCode">Save Code</h2>
                <button id="close-save-modal" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-6 space-y-4">
                <label for="save-name-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="saveCodePrompt">Enter a name for this QR Code:</label>
                <input type="text" id="save-name-input" class="mt-1 block w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <!-- Modal Footer -->
            <div class="flex justify-end gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-b-lg">
                <button id="cancel-save-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600" data-lang="cancel">Cancel</button>
                <button id="confirm-save-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md shadow-sm" data-lang="save">Save</button>
            </div>
        </div>
    </div>


    <!-- JavaScript Utama -->
    <script type="module">
        // --- Setup Awal ---
        // Kamus Terjemahan
        const translations = {
            'en': {
                title: "QR Code Generator Pro",
                subtitle: "Free QR Code Generator PRO Multi Function",
                col1Title: "1. Select QR Code Type",
                tabSingle: "Single URL",
                tabMulti: "Multi URL",
                tabVcard: "vCard",
                tabWhatsapp: "WhatsApp",
                singleUrlLabel: "Enter Your Website URL",
                singleUrlPlaceholder: "https://www.your-website.com",
                multiUrlTitle: "Page Title",
                multiUrlTitlePlaceholder: "My Links Page",
                multiUrlLinks: "Links",
                multiUrlAddLink: "Add Link",
                preview: "Preview",
                previewTitle: "Page Preview",
                multiUrlLinkLabel: "Label",
                multiUrlLinkLabelPlaceholder: "e.g., My Website",
                multiUrlLinkUrl: "URL",
                multiUrlLinkUrlPlaceholder: "https://...",
                multiUrlEmpty: "No links added yet. Click 'Add Link' to start.",
                vcardFirstName: "First Name",
                vcardLastName: "Last Name",
                vcardPhone: "Phone",
                vcardEmail: "Email",
                vcardCompany: "Company",
                vcardTitle: "Job Title",
                vcardNote: "Note",
                vcardSocials: "Social Media",
                vcardAddSocial: "Add Other Social",
                vcardCustom: "Custom Fields",
                vcardAddField: "Add Custom Field",
                vcardCustomLabelPlaceholder: "e.g. Website",
                vcardCustomValuePlaceholder: "e.g. https://...",
                vcardCustomEmpty: "No custom fields yet.",
                vcardCustomSocialLabelPlaceholder: "e.g. Mastodon",
                vcardCustomSocialValuePlaceholder: "Username",
                whatsappLabel: "Enter WhatsApp Number",
                whatsappHint: "Will be auto-formatted to a wa.me link.",
                whatsappPlaceholder: "e.g., +62812345678",
                col2Title: "2. Customize QR Code",
                styleColors: "Colors",
                styleDots: "Dots",
                styleBg: "Background",
                styleCornerSquare: "Corner Squares",
                styleCornerDot: "Corner Dots", 
                styleShape: "Shape & Style",
                styleDotsType: "Dots Style",
                styleCornerSquareType: "Corner Square Style",
                styleCornerDotType: "Corner Dot Style", 
                styleLogo: "Logo",
                styleLogoUpload: "Choose image...",
                col3Title: "3. Download QR Code",
                // Teks Kustom
                styleCustomText: "Custom Text",
                styleCustomTextHint: "Appears below the logo (or in center).",
                styleCustomTextPlaceholder: "Your Text...",
                styleTextColor: "Text Color",
                defaultTextWhatsapp: "WHATSAPP",
                // IndexedDB & Share
                myCodes: "My Codes",
                saveCode: "Save Code",
                saveCodePrompt: "Enter a name for this QR Code:",
                shareLink: "Share Link",
                copy: "Copy",
                copied: "Copied!",
                historyEmpty: "You have no saved QR Codes.",
                historyLoad: "Load",
                historyDelete: "Delete",
                historyDeleteConfirm: "Are you sure you want to delete this code?",
                alertSaveError: "Error preparing data to save. Please try again.",
                cancel: "Cancel", 
                save: "Save", 
                vcardSocialFacebook: "Facebook (Username or URL)",
                vcardSocialInstagram: "Instagram (Username or URL)",
                vcardSocialTikTok: "TikTok (Username or URL)",
                vcardSocialLinkedIn: "LinkedIn (Username or URL)",
                vcardSocialX: "X / Twitter (Username or URL)",
                footerCreate: "Create your own QR Code", // [PERBAIKAN] Teks baru
            },
            'id': {
                title: "QR Code Generator Pro",
                subtitle: "Generator QR Code PRO Multi Fungsi Gratis",
                col1Title: "1. Pilih Tipe QR Code",
                tabSingle: "URL Tunggal",
                tabMulti: "Multi URL",
                tabVcard: "vCard",
                tabWhatsapp: "WhatsApp",
                singleUrlLabel: "Masukkan URL Website Anda",
                singleUrlPlaceholder: "https://www.website-anda.com",
                multiUrlTitle: "Judul Halaman",
                multiUrlTitlePlaceholder: "Halaman Tautan Saya",
                multiUrlLinks: "Tautan",
                multiUrlAddLink: "Tambah Tautan",
                preview: "Pratinjau",
                previewTitle: "Pratinjau Halaman",
                multiUrlLinkLabel: "Label",
                multiUrlLinkLabelPlaceholder: "cth: Website Saya",
                multiUrlLinkUrl: "URL",
                multiUrlLinkUrlPlaceholder: "https://...",
                multiUrlEmpty: "Belum ada tautan. Klik 'Tambah Tautan' untuk memulai.",
                vcardFirstName: "Nama Depan",
                vcardLastName: "Nama Belakang",
                vcardPhone: "Telepon",
                vcardEmail: "Email",
                vcardCompany: "Perusahaan",
                vcardTitle: "Jabatan",
                vcardNote: "Catatan",
                vcardSocials: "Media Sosial",
                vcardAddSocial: "Tambah Sosmed Lain",
                vcardCustom: "Kolom Kustom",
                vcardAddField: "Tambah Kolom Kustom",
                vcardCustomLabelPlaceholder: "cth: Website",
                vcardCustomValuePlaceholder: "cth: https://...",
                vcardCustomEmpty: "Belum ada kolom kustom.",
                vcardCustomSocialLabelPlaceholder: "cth: Mastodon",
                vcardCustomSocialValuePlaceholder: "Username",
                whatsappLabel: "Masukkan Nomor WhatsApp",
                whatsappHint: "Akan diformat otomatis ke tautan wa.me.",
                whatsappPlaceholder: "cth: +62812345678",
                col2Title: "2. Kustomisasi Tampilan",
                styleColors: "Warna",
                styleDots: "Titik",
                styleBg: "Latar Belakang",
                styleCornerSquare: "Kotak Pojok",
                styleCornerDot: "Titik Pojok", 
                styleShape: "Bentuk & Gaya",
                styleDotsType: "Gaya Titik",
                styleCornerSquareType: "Gaya Kotak Pojok",
                styleCornerDotType: "Gaya Titik Pojok", 
                styleLogo: "Logo",
                styleLogoUpload: "Pilih gambar...",
                col3Title: "3. Unduh QR Code",
                // Teks Kustom
                styleCustomText: "Teks Kustom",
                styleCustomTextHint: "Tampil di bawah logo (atau di tengah).",
                styleCustomTextPlaceholder: "Teks Anda...",
                styleTextColor: "Warna Teks",
                defaultTextWhatsapp: "WHATSAPP",
                // IndexedDB & Share
                myCodes: "Kode Saya",
                saveCode: "Simpan Kode",
                saveCodePrompt: "Masukkan nama untuk QR Code ini:",
                shareLink: "Bagikan Tautan",
                copy: "Salin",
                copied: "Tersalin!",
                historyEmpty: "Anda belum memiliki QR Code tersimpan.",
                historyLoad: "Muat",
                historyDelete: "Hapus",
                historyDeleteConfirm: "Apakah Anda yakin ingin menghapus kode ini?",
                alertSaveError: "Gagal menyiapkan data untuk disimpan. Silakan coba lagi.",
                cancel: "Batal", 
                save: "Simpan", 
                vcardSocialFacebook: "Facebook (Username atau URL)",
                vcardSocialInstagram: "Instagram (Username atau URL)",
                vcardSocialTikTok: "TikTok (Username atau URL)",
                vcardSocialLinkedIn: "LinkedIn (Username atau URL)",
                vcardSocialX: "X / Twitter (Username atau URL)",
                footerCreate: "Buat QR Code Anda sendiri", // [PERBAIKAN] Teks baru
            }
        };
        let currentLang = 'en'; // Default bahasa Inggris

        // --- Cache Elemen DOM ---
        // [PERBAIKAN] Cache elemen baru
        const generatorHeader = document.getElementById('generator-header');
        const generatorMain = document.getElementById('generator-main');
        const landingPage = document.getElementById('landing-page');
        const landingTitle = document.getElementById('landing-title');
        const landingLinksContainer = document.getElementById('landing-links-container');
        
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIconSun = document.getElementById('theme-icon-sun');
        const themeIconMoon = document.getElementById('theme-icon-moon');
        const langToggleBtn = document.getElementById('lang-toggle-btn');
        const qrCodePreview = document.getElementById('qr-code-preview');
        const singleUrlInput = document.getElementById('single-url');
        const multiTitleInput = document.getElementById('multi-title');
        const multiLinksContainer = document.getElementById('multi-links-container');
        const multiAddLinkBtn = document.getElementById('multi-add-link');
        const multiPreviewBtn = document.getElementById('multi-preview-btn');
        const whatsappNumber = document.getElementById('whatsapp-number');

        const previewModal = document.getElementById('preview-modal');
        const closePreviewModal = document.getElementById('close-preview-modal');
        const previewContent = document.getElementById('preview-content');
        const vcardAddFieldBtn = document.getElementById('vcard-add-field');
        const vcardFieldsContainer = document.getElementById('vcard-fields-container');
        const vcardAddSocialBtn = document.getElementById('vcard-add-social');
        const vcardSocialsContainer = document.getElementById('vcard-socials-container');
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryModal = document.getElementById('close-history-modal');
        const historyList = document.getElementById('history-list');
        const saveCodeBtn = document.getElementById('save-code-btn');
        const shareLinkWrapper = document.getElementById('share-link-wrapper');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyLinkBtn = document.getElementById('copy-link-btn');

        const saveModal = document.getElementById('save-modal');
        const closeSaveModal = document.getElementById('close-save-modal');
        const saveNameInput = document.getElementById('save-name-input');
        const cancelSaveBtn = document.getElementById('cancel-save-btn');
        const confirmSaveBtn = document.getElementById('confirm-save-btn');

        // Elemen kustomisasi
        const colorDots = document.getElementById('color-dots');
        const colorBg = document.getElementById('color-bg');
        const colorCornerSquare = document.getElementById('color-corner-square');
        const colorCornerDot = document.getElementById('color-corner-dot'); 
        const styleDots = document.getElementById('style-dots');
        const styleCornerSquare = document.getElementById('style-corner-square');
        const styleCornerDot = document.getElementById('style-corner-dot'); 
        const logoUpload = document.getElementById('logo-upload');
        const logoRemove = document.getElementById('logo-remove');
        const customTextInput = document.getElementById('custom-text');
        const customTextColorInput = document.getElementById('custom-text-color');
        const textRemoveBtn = document.getElementById('text-remove');

        const downloadPngBtn = document.getElementById('download-png-btn');
        const downloadSvgBtn = document.getElementById('download-svg-btn');

        // Elemen vCard (cache yang sering diakses)
        const vcardInputs = {
            firstName: document.getElementById('vcard-first-name'),
            lastName: document.getElementById('vcard-last-name'),
            phone: document.getElementById('vcard-phone'),
            email: document.getElementById('vcard-email'),
            company: document.getElementById('vcard-company'),
            title: document.getElementById('vcard-title'),
            note: document.getElementById('vcard-note'),
            socials: {
                facebook: document.getElementById('vcard-social-facebook'),
                instagram: document.getElementById('vcard-social-instagram'),
                tiktok: document.getElementById('vcard-social-tiktok'),
                linkedin: document.getElementById('vcard-social-linkedin'),
                x: document.getElementById('vcard-social-x'),
            }
        };

        // --- State Aplikasi ---
        let activeTab = 'single';
        let multiLinksData = [];
        let vcardCustomFields = [];
        let vcardCustomSocials = [];
        let logoImage = null; // Ini akan menyimpan objek new Image(), bukan Base64
        let customText = '';
        let customTextColor = '#000000';
        let userHasEditedText = false; // Lacak editan manual
        let db = null; // Variabel untuk instance IndexedDB
        let pendingSaveConfig = null; 

        // --- Inisialisasi QR Code Instance ---
        const qrCodeInstance = new QRCodeStyling({
            width: 240,
            height: 240,
            type: 'svg',
            data: 'https://github.com/gemini',
            image: '',
            dotsOptions: {
                color: '#000000',
                type: 'square'
            },
            backgroundOptions: {
                color: '#ffffff',
            },
            cornersSquareOptions: {
                color: '#000000',
                type: 'square'
            },
            cornersDotOptions: { 
                color: '#000000',
                type: 'square'
            },
            imageOptions: {
                crossOrigin: 'anonymous',
                margin: 5,
                imageSize: 0.4 // 40% dari ukuran QR
            }
        });

        // --- Inisialisasi IndexedDB ---
        function initDB() {
            const request = indexedDB.open('QRCodeGeneratorDB', 1);

            request.onerror = (event) => {
                console.error('IndexedDB error:', event.target.error);
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                db.createObjectStore('qrcodes', { keyPath: 'id' });
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('IndexedDB accessed successfully.');
            };
        }

        // --- Fungsi IndexedDB ---
        function formatUrl(url) {
            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                return 'http://' + url;
            }
            return url;
        }

        async function getCurrentConfig() {
            // 1. Kumpulkan Data Input
            const vcardData = {};
            for (const key in vcardInputs) {
                if (key !== 'socials') {
                    vcardData[key] = vcardInputs[key].value;
                }
            }
            vcardData.socials = {};
            for (const key in vcardInputs.socials) {
                vcardData.socials[key] = vcardInputs.socials[key].value;
            }

            const compositeImage = await getCompositeImageDataUrl();

            // Tambahan: Dapatkan data URL dari QR code SVG yang ditampilkan
            const svgElement = qrCodePreview.querySelector('svg');
            let fullQrImage = null;
            if (svgElement) {
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svgElement);
                fullQrImage = 'data:image/svg+xml;base64,' + btoa(svgString);
            }

            // 2. Kumpulkan Opsi Kustomisasi
            const currentStyles = {
                dotsOptions: {
                    type: styleDots.value,
                    color: colorDots.value
                },
                backgroundOptions: {
                    color: colorBg.value
                },
                cornersSquareOptions: {
                    type: styleCornerSquare.value,
                    color: colorCornerSquare.value
                },
                cornersDotOptions: {
                    type: styleCornerDot.value,
                    color: colorCornerDot.value
                },
                originalLogo: logoImage ? logoImage.src : null,
                compositeImage: compositeImage,
                fullQrImage: fullQrImage // Simpan data URL QR code lengkap
            };

            // 3. Kembalikan Objek Konfigurasi Lengkap
            return {
                id: crypto.randomUUID(),
                activeTab: activeTab,
                styles: currentStyles,
                data: {
                    singleUrl: singleUrlInput.value,
                    multiTitle: multiTitleInput.value,
                    multiLinks: multiLinksData, // array
                    vcardData: vcardData, // objek
                    vcardCustomFields: vcardCustomFields, // array
                    vcardCustomSocials: vcardCustomSocials, // array
                    whatsappNumber: whatsappNumber.value,
                    // Simpan data teks kustom
                    customText: customText,
                    customTextColor: customTextColor,
                    userHasEditedText: userHasEditedText
                },
                timestamp: new Date().toISOString()
            };
        }

        async function saveQRCode() {
            let config;
            let name;

            try {
                // [PERBAIKAN] Tunggu konfigurasi yang benar-benar selesai
                config = await getCurrentConfig();
                
                // Coba dapatkan nama yang deskriptif
                switch(activeTab) {
                    case 'single':
                        const url = (config.data.singleUrl || '').replace(/^(https?:\/\/)?(www\.)?/, '').replace(/\/$/, '');
                        name = url || 'Single URL';
                        break;
                    case 'multi':
                        name = config.data.multiTitle || 'Multi URL Page';
                        break;
                    case 'vcard':
                        const first = config.data.vcardData.firstName || '';
                        const last = config.data.vcardData.lastName || '';
                        name = (first + ' ' + last).trim() || 'vCard Contact';
                        break;
                    case 'whatsapp':
                        name = config.data.whatsappNumber ? `WA: ${config.data.whatsappNumber}` : 'WhatsApp Link';
                        break;
                    default:
                        name = `qrcode-${new Date().toISOString().substring(0, 10)}`;
                }

                if (name.length > 50) {
                    name = name.substring(0, 47) + '...';
                }
                
            } catch (error) {
                console.error("Error preparing save data:", error);
                console.error(translations[currentLang].alertSaveError);
                return; 
            }

            pendingSaveConfig = config;
            saveNameInput.value = name; // Isi nama default
            saveModal.classList.remove('hidden');
            saveNameInput.focus();
            saveNameInput.select();
        }

        function executeSave() {
            const finalName = saveNameInput.value;
            if (finalName === null || finalName.trim() === '') {
                return; 
            }
            
            if (!pendingSaveConfig) {
                console.error("No pending config to save.");
                return;
            }
            
            pendingSaveConfig.name = finalName; 
            
            if (!db) {
                console.error("Database not initialized.");
                return;
            }

            const transaction = db.transaction(['qrcodes'], 'readwrite');
            const objectStore = transaction.objectStore('qrcodes');
            const request = objectStore.add(pendingSaveConfig);

            request.onsuccess = () => {
                console.log('QR Code saved!');
                saveModal.classList.add('hidden');
                pendingSaveConfig = null;
            };

            request.onerror = (event) => {
                console.error('Error saving QR Code:', event.target.error);
                saveModal.classList.add('hidden'); 
                pendingSaveConfig = null;
            };
        }


        function loadQRCode(id) {
            if (!db) return;
            const transaction = db.transaction(['qrcodes'], 'readonly');
            const objectStore = transaction.objectStore('qrcodes');
            const request = objectStore.get(id);

            request.onerror = (e) => console.error('Error loading QR Code:', e.target.error);

            request.onsuccess = (e) => {
                const config = e.target.result;
                if (!config) {
                    console.error('No config found for id:', id);
                    return;
                }
                
                // 1. Restore Styles
                const savedStyles = config.styles || {
                    dotsOptions: { color: '#000000', type: 'square' },
                    backgroundOptions: { color: '#ffffff' },
                    cornersSquareOptions: { color: '#000000', type: 'square' },
                    cornersDotOptions: { color: '#000000', type: 'square' }, 
                    originalLogo: null
                };
                
                const savedLogoSrc = savedStyles.originalLogo || null;
                
                // [FIX] Create a clean options object to avoid passing unknown properties
                const updateOptions = {
                    dotsOptions: savedStyles.dotsOptions,
                    backgroundOptions: savedStyles.backgroundOptions,
                    cornersSquareOptions: savedStyles.cornersSquareOptions,
                    cornersDotOptions: savedStyles.cornersDotOptions,
                    image: null // Start with no image; it will be loaded later
                };
                qrCodeInstance.update(updateOptions);
                
                // Update input kustomisasi (agar UI sinkron)
                colorDots.value = savedStyles.dotsOptions.color || '#000000';
                colorBg.value = savedStyles.backgroundOptions.color || '#ffffff';
                colorCornerSquare.value = savedStyles.cornersSquareOptions.color || '#000000';
                colorCornerDot.value = savedStyles.cornersDotOptions?.color || '#000000'; 
                styleDots.value = savedStyles.dotsOptions.type || 'square';
                styleCornerSquare.value = savedStyles.cornersSquareOptions.type || 'square';
                styleCornerDot.value = savedStyles.cornersDotOptions?.type || 'square'; 

                // 2. Restore Data
                const data = config.data || {};
                
                singleUrlInput.value = data.singleUrl || '';
                multiTitleInput.value = data.multiTitle || '';
                multiLinksData = data.multiLinks || [];
                
                const vcardData = data.vcardData || {};
                for (const key in vcardInputs) {
                    if (key !== 'socials' && vcardInputs[key]) {
                        vcardInputs[key].value = vcardData[key] || '';
                    }
                }
                const vcardSocials = vcardData.socials || {};
                for (const key in vcardInputs.socials) {
                    if (vcardInputs.socials[key]) {
                        vcardInputs.socials[key].value = vcardSocials[key] || '';
                    }
                }
                
                vcardCustomFields = data.vcardCustomFields || [];
                vcardCustomSocials = data.vcardCustomSocials || [];
                
                whatsappNumber.value = data.whatsappNumber || '';
                
                // Restore data Teks Kustom
                customText = data.customText || '';
                customTextColor = data.customTextColor || '#000000';
                userHasEditedText = data.userHasEditedText || false; // Restore status editan
                customTextInput.value = customText;
                customTextColorInput.value = customTextColor;
                
                // 3. Render Ulang UI
                renderMultiLinksList();
                renderVcardCustomFields();
                renderVcardCustomSocials();
                
                // 4. Set Tab Aktif (ini akan memanggil updateQrData)
                setActiveTab(config.activeTab || 'single');
                
                // 5. Tutup Modal
                historyModal.classList.add('hidden');

                // 6. Load logo (jika ada) dan regenerasi gambar overlay
                if (savedLogoSrc) {
                    logoImage = new Image();
                    logoImage.crossOrigin = "anonymous"; // Penting untuk canvas
                    logoImage.onload = () => {
                        generateOverlayImage(); // Panggil setelah logo di-load
                    };
                    logoImage.onerror = () => {
                        console.error("Failed to load saved logo");
                        logoImage = null;
                        generateOverlayImage();
                    };
                    logoImage.src = savedLogoSrc;
                } else {
                    logoImage = null;
                    generateOverlayImage(); // Panggil meski tanpa logo (untuk teks)
                }

                console.log('QR Code loaded!');
            };
        }

        function deleteQRCode(id) {
            if (!db) return;
            // Konfirmasi dihapus karena window.confirm() diblokir
            
            const transaction = db.transaction(['qrcodes'], 'readwrite');
            const objectStore = transaction.objectStore('qrcodes');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                console.log('QR Code deleted!');
                showHistory(); // Refresh daftar history
            };
            request.onerror = (e) => console.error('Error deleting QR Code:', e.target.error);
        }

        function showHistory() {
            if (!db) return;
            const transaction = db.transaction(['qrcodes'], 'readonly');
            const objectStore = transaction.objectStore('qrcodes');
            const request = objectStore.getAll();

            request.onerror = (e) => console.error('Error fetching history:', e.target.error);

            request.onsuccess = (e) => {
                const codes = e.target.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Urutkan, terbaru dulu
                historyList.innerHTML = ''; // Kosongkan daftar

                if (codes.length === 0) {
                    historyList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center" data-lang="historyEmpty">${translations[currentLang].historyEmpty}</p>`;
                    return;
                }

                codes.forEach(code => {
                    let previewImg = '';
                    const styles = code.styles || {};

                    // Gunakan fullQrImage jika ada, jika tidak, fallback ke metode lama
                    if (styles.fullQrImage) {
                        previewImg = `<img src="${styles.fullQrImage}" alt="QR Code Preview" class="w-full h-full object-contain">`;
                    } else if (styles.dotsOptions) {
                        // Fallback untuk kode yang disimpan sebelum pembaruan
                        const miniQR = new QRCodeStyling({
                            width: 60,
                            height: 60,
                            type: 'svg',
                            data: 'preview',
                            dotsOptions: styles.dotsOptions,
                            backgroundOptions: styles.backgroundOptions,
                            cornersSquareOptions: styles.cornersSquareOptions,
                            cornersDotOptions: styles.cornersDotOptions, 
                            image: styles.compositeImage || '', 
                            imageOptions: {
                                crossOrigin: 'anonymous',
                                margin: 2, 
                                imageSize: 0.4
                            }
                        });
                        const tempDiv = document.createElement('div');
                        miniQR.append(tempDiv);
                        previewImg = tempDiv.innerHTML; 
                    } else {
                        // Fallback jika data styles rusak total
                        previewImg = `<div class="w-[60px] h-[60px] flex items-center justify-center bg-gray-200 dark:bg-gray-600 rounded-md">
                            <i data-lucide="image-off" class="w-6 h-6 text-gray-400"></i>
                        </div>`;
                    }
                    
                    const date = new Date(code.timestamp).toLocaleString(currentLang.startsWith('id') ? 'id-ID' : 'en-US', { dateStyle: 'medium', timeStyle: 'short' });

                    const item = document.createElement('div');
                    item.className = 'flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600';
                    item.innerHTML = `
                        <div class="flex-shrink-0 w-[60px] h-[60px] rounded-md overflow-hidden bg-white">
                            ${previewImg}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold truncate" title="${code.name}">${code.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${date}</p>
                        </div>
                        <div class="flex-shrink-0 flex gap-2">
                            <button class="load-btn p-2 text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400" data-id="${code.id}" title="${translations[currentLang].historyLoad}">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-btn p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500" data-id="${code.id}" title="${translations[currentLang].historyDelete}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    historyList.appendChild(item);
                });

                // Ganti ikon setelah item ditambahkan
                lucide.createIcons();

                // Tambahkan event listener untuk tombol baru
                historyList.querySelectorAll('.load-btn').forEach(btn => {
                    btn.onclick = () => loadQRCode(btn.dataset.id);
                });
                historyList.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.onclick = () => deleteQRCode(btn.dataset.id);
                });
            };
        }


        // --- Fungsi Utilitas ---
        function formatWaNumber(phone) {
            let num = phone.replace(/\D/g, ''); // Hapus semua non-digit
            if (num.startsWith('0')) {
                num = '62' + num.substring(1); // Ganti 0 di depan dengan 62
            }
            if (!num.startsWith('62')) {
                if (num.length > 9 && num.length < 15) {
                    num = '62' + num;
                }
            }
            return 'https://wa.me/' + num;
        }

        function normalizeSocialURL(input, platform) {
            if (!input || input.trim() === '') return null;
            input = input.trim();
            
            if (input.startsWith('http://') || input.startsWith('https://')) {
                return input;
            }

            switch(platform.toLowerCase()) {
                case 'facebook':
                    return `https://www.facebook.com/${input}`;
                case 'instagram':
                    return `https://www.instagram.com/${input}`;
                case 'tiktok':
                    return `https://www.tiktok.com/@${input.replace('@', '')}`;
                case 'linkedin':
                    return `https://www.linkedin.com/in/${input}`;
                case 'x':
                case 'twitter':
                    return `https://x.com/${input}`;
                default:
                    if (!input.includes('.')) return null; 
                    return `https://${input}`;
            }
        }

        function getCompositeImageDataUrl() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 200;
                canvas.width = size;
                canvas.height = size;

                const hasText = customText.trim() !== '';
                // Periksa apakah logo ada dan siap untuk digambar
                const isLogoReady = logoImage && logoImage.complete && logoImage.naturalWidth > 0;

                const drawCanvas = (logoToDraw) => {
                    if (!logoToDraw && !hasText) {
                        resolve(null);
                        return;
                    }

                    ctx.clearRect(0, 0, size, size);
                    ctx.font = 'bold 24px sans-serif';
                    ctx.fillStyle = customTextColor;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    if (logoToDraw) {
                        const logoRatio = logoToDraw.width / logoToDraw.height;
                        const maxSize = size * 0.5;

                        let logoW = maxSize;
                        let logoH = maxSize;

                        if (logoRatio > 1) { // Landscape
                            logoH = maxSize / logoRatio;
                        } else { // Portrait or Square
                            logoW = maxSize * logoRatio;
                        }

                        const logoX = (size - logoW) / 2;
                        const logoY = size * 0.15;

                        try {
                            ctx.drawImage(logoToDraw, logoX, logoY, logoW, logoH);
                        } catch (e) {
                            console.error("Error drawing logo:", e);
                        }

                        if (hasText) {
                            const textY = logoY + logoH + 20;
                            ctx.fillText(customText, size / 2, textY, size * 0.9);
                        }
                    } else if (hasText) {
                        ctx.fillText(customText, size / 2, size / 2, size * 0.9);
                    }

                    resolve(canvas.toDataURL('image/png'));
                };

                if (logoImage && !isLogoReady) {
                    // Jika objek gambar ada tetapi belum dimuat, tunggu
                    logoImage.onload = () => drawCanvas(logoImage);
                    logoImage.onerror = () => {
                        console.error("Logo failed to load for composite image.");
                        drawCanvas(null); // Gambar tanpa logo
                    };
                } else {
                    // Jika logo sudah siap atau tidak ada, gambar segera
                    drawCanvas(isLogoReady ? logoImage : null);
                }
            });
        }

        async function generateOverlayImage() {
            const dataUrl = await getCompositeImageDataUrl();
            qrCodeInstance.update({ image: dataUrl });
        }

        async function updateQrData() {
            // 1. Tentukan Default Teks
            let defaultText = '';
            switch (activeTab) {
                case 'single':
                    let url = singleUrlInput.value || '';
                    defaultText = url.replace(/^(https?:\/\/)?(www\.)?/, '').replace(/\/$/, '');
                    if (defaultText.length > 25) defaultText = defaultText.substring(0, 22) + '...';
                    break;
                case 'multi':
                    defaultText = multiTitleInput.value;
                    break;
                case 'vcard':
                    const first = vcardInputs.firstName.value || '';
                    const last = vcardInputs.lastName.value || '';
                    defaultText = (first + ' ' + last).trim().toUpperCase();
                    break;
                case 'whatsapp':
                    defaultText = translations[currentLang].defaultTextWhatsapp;
                    break;
            }

            // 2. Update input teks jika user belum mengedit
            if (!userHasEditedText) {
                customTextInput.value = defaultText;
                customText = defaultText;
            }
            
            // 3. Generate gambar overlay (sekarang async)
            await generateOverlayImage();

            // 4. Tentukan Data untuk Di-encode
            let dataToEncode = 'https://github.com/gemini';
            
            switch (activeTab) {
                case 'single':
                    dataToEncode = formatUrl(singleUrlInput.value) || 'https://github.com/gemini';
                    break;
                case 'multi':
                    const formattedLinks = multiLinksData.map(link => ({
                        ...link,
                        url: formatUrl(link.url)
                    }));
                    const pageData = {
                        title: multiTitleInput.value,
                        links: formattedLinks,
                        logo: logoImage ? logoImage.src : null
                    };
                    const encodedData = btoa(unescape(encodeURIComponent(JSON.stringify(pageData))));
                    const url = new URL(window.location.href);
                    dataToEncode = `${url.origin}${url.pathname}?data=${encodedData}`;
                    shareLinkInput.value = dataToEncode; // Update link share
                    break;
                case 'vcard':
                    let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
                    vcard += `N:${vcardInputs.lastName.value};${vcardInputs.firstName.value}\n`;
                    vcard += `FN:${vcardInputs.firstName.value} ${vcardInputs.lastName.value}\n`;
                    if (vcardInputs.phone.value) vcard += `TEL;TYPE=CELL:${vcardInputs.phone.value}\n`;
                    if (vcardInputs.email.value) vcard += `EMAIL:${vcardInputs.email.value}\n`;
                    if (vcardInputs.company.value) vcard += `ORG:${vcardInputs.company.value}\n`;
                    if (vcardInputs.title.value) vcard += `TITLE:${vcardInputs.title.value}\n`;
                    if (vcardInputs.note.value) vcard += `NOTE:${vcardInputs.note.value.replace(/\n/g, '\\n')}\n`;
                    
                    const facebookUrl = normalizeSocialURL(vcardInputs.socials.facebook.value, 'facebook');
                    if (facebookUrl) vcard += `X-SOCIALPROFILE;TYPE=facebook:${facebookUrl}\n`;
                    
                    const instagramUrl = normalizeSocialURL(vcardInputs.socials.instagram.value, 'instagram');
                    if (instagramUrl) vcard += `X-SOCIALPROFILE;TYPE=instagram:${instagramUrl}\n`;

                    const tiktokUrl = normalizeSocialURL(vcardInputs.socials.tiktok.value, 'tiktok');
                    if (tiktokUrl) vcard += `X-SOCIALPROFILE;TYPE=tiktok:${tiktokUrl}\n`;

                    const linkedinUrl = normalizeSocialURL(vcardInputs.socials.linkedin.value, 'linkedin');
                    if (linkedinUrl) vcard += `X-SOCIALPROFILE;TYPE=linkedin:${linkedinUrl}\n`;

                    const xUrl = normalizeSocialURL(vcardInputs.socials.x.value, 'x');
                    if (xUrl) vcard += `X-SOCIALPROFILE;TYPE=twitter:${xUrl}\n`;
                    
                    vcardCustomSocials.forEach(social => {
                        if (social.label && social.value) {
                            const platform = social.label.toLowerCase();
                            const socialUrl = normalizeSocialURL(social.value, platform);
                            if (socialUrl) {
                                vcard += `X-SOCIALPROFILE;TYPE=${platform}:${socialUrl}\n`;
                            }
                        }
                    });

                    vcardCustomFields.forEach(field => {
                        if (field.label && field.value) {
                            const label = field.label.toUpperCase();
                            if (label === 'WEBSITE' || label === 'URL') {
                                vcard += `URL:${field.value}\n`;
                            } else if (label === 'ADDRESS' || label === 'ALAMAT') {
                                vcard += `ADR;TYPE=HOME:;;${field.value.replace(/\n/g, ' ')}\n`;
                            } else {
                                vcard += `X-${field.label.replace(/\s/g, '-')}:${field.value}\n`;
                            }
                        }
                    });

                    vcard += 'END:VCARD';
                    dataToEncode = vcard;
                    break;
                case 'whatsapp':
                    dataToEncode = formatWaNumber(whatsappNumber.value);
                    break;
            }

            // 5. Update data QR code
            qrCodeInstance.update({ data: dataToEncode });
        }

        // Fungsi render dinamis (dibuat global di window agar setLanguage bisa memanggilnya)
        window.renderMultiLinksList = () => {
            multiLinksContainer.innerHTML = '';
            if (multiLinksData.length === 0) {
                multiLinksContainer.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400 text-center" data-lang="multiUrlEmpty">${translations[currentLang].multiUrlEmpty}</p>`;
                return;
            }
            multiLinksData.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600';
                div.innerHTML = `
                    <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-400 dark:text-gray-500 cursor-move"></i>
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <input type="text" value="${link.label}" data-lang-placeholder="multiUrlLinkLabel" placeholder="${translations[currentLang].multiUrlLinkLabelPlaceholder}" data-index="${index}" data-field="label" class="multi-link-input text-sm block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" value="${link.url}" data-lang-placeholder="multiUrlLinkUrl" placeholder="${translations[currentLang].multiUrlLinkUrlPlaceholder}" data-index="${index}" data-field="url" class="multi-link-input text-sm block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button class="multi-link-remove p-2 text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-500" data-index="${index}">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                multiLinksContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        window.renderVcardCustomFields = () => {
            vcardFieldsContainer.innerHTML = '';
            if (vcardCustomFields.length === 0) {
                vcardFieldsContainer.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400 text-center" data-lang="vcardCustomEmpty">${translations[currentLang].vcardCustomEmpty}</p>`;
                return;
            }
            vcardCustomFields.forEach((field, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <input type="text" value="${field.label}" data-lang-placeholder="vcardCustomLabelPlaceholder" placeholder="${translations[currentLang].vcardCustomLabelPlaceholder}" data-index="${index}" data-field="label" class="vcard-field-input text-sm block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" value="${field.value}" data-lang-placeholder="vcardCustomValuePlaceholder" placeholder="${translations[currentLang].vcardCustomValuePlaceholder}" data-index="${index}" data-field="value" class="vcard-field-input text-sm block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button class="vcard-field-remove p-2 text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-500" data-index="${index}">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                vcardFieldsContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        window.renderVcardCustomSocials = () => {
            vcardSocialsContainer.innerHTML = '';
            vcardCustomSocials.forEach((social, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <input type="text" value="${social.label}" data-lang-placeholder="vcardCustomSocialLabelPlaceholder" placeholder="${translations[currentLang].vcardCustomSocialLabelPlaceholder}" data-index="${index}" data-field="label" class="vcard-social-input text-sm block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" value="${social.value}" data-lang-placeholder="vcardCustomSocialValuePlaceholder" placeholder="${translations[currentLang].vcardCustomSocialValuePlaceholder}" data-index="${index}" data-field="value" class="vcard-social-input text-sm block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button class="vcard-social-remove p-2 text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-500" data-index="${index}">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                vcardSocialsContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- Fungsi Bahasa & Tema ---
        window.setLanguage = (lang) => {
            if (!['en', 'id'].includes(lang)) lang = 'en';
            currentLang = lang;
            localStorage.setItem('lang', lang);
            
            langToggleBtn.querySelector('span').textContent = lang.toUpperCase();
            document.documentElement.lang = lang;
            
            const dict = translations[lang];
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (dict[key]) {
                    el.textContent = dict[key];
                }
            });
            
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (dict[key]) {
                    el.placeholder = dict[key];
                }
            });

            // Render ulang daftar dinamis untuk memperbarui placeholder
            window.renderMultiLinksList();
            window.renderVcardCustomFields();
            window.renderVcardCustomSocials();
            // Perbarui teks default jika perlu
            updateQrData();
        }

        function toggleTheme() {
            const isDarkMode = document.documentElement.classList.toggle('dark');
            document.documentElement.classList.toggle('light', !isDarkMode);
            themeIconSun.classList.toggle('hidden', isDarkMode);
            themeIconMoon.classList.toggle('hidden', !isDarkMode);
            localStorage.theme = isDarkMode ? 'dark' : 'light';
        }

        // --- Inisialisasi Generator ---
        function initGenerator() {
            // Pasang QR code ke DOM
            qrCodeInstance.append(qrCodePreview);
            
            // Inisialisasi DB
            initDB();

            // Setel Tema Awal
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
                themeIconSun.classList.add('hidden');
                themeIconMoon.classList.remove('hidden');
            } else {
                document.documentElement.classList.add('light');
                document.documentElement.classList.remove('dark');
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
            }

            // Setel Bahasa Awal
            const savedLang = localStorage.getItem('lang') || 'en'; // Default Inggris
            window.setLanguage(savedLang);

            // Listener Tema & Bahasa
            themeToggleBtn.addEventListener('click', toggleTheme);
            langToggleBtn.addEventListener('click', () => {
                const newLang = currentLang === 'en' ? 'id' : 'en';
                window.setLanguage(newLang);
            });
            
            // Logika Tab
            const tabs = [
                { name: 'single', btn: document.getElementById('tab-single'), panel: document.getElementById('panel-single') },
                { name: 'multi', btn: document.getElementById('tab-multi'), panel: document.getElementById('panel-multi') },
                { name: 'vcard', btn: document.getElementById('tab-vcard'), panel: document.getElementById('panel-vcard') },
                { name: 'whatsapp', btn: document.getElementById('tab-whatsapp'), panel: document.getElementById('panel-whatsapp') },
            ];

            window.setActiveTab = (tabName) => {
                activeTab = tabName;
                tabs.forEach(tab => {
                    const isActive = tab.name === tabName;
                    tab.btn.classList.toggle('bg-indigo-600', isActive);
                    tab.btn.classList.toggle('text-white', isActive);
                    tab.btn.classList.toggle('dark:bg-indigo-600', isActive);
                    tab.btn.classList.toggle('border-indigo-600', isActive);
                    tab.btn.classList.toggle('dark:border-indigo-600', isActive);
                    
                    tab.btn.classList.toggle('hover:bg-gray-100', !isActive);
                    tab.btn.classList.toggle('dark:hover:bg-gray-700', !isActive);
                    tab.btn.classList.toggle('border-gray-300', !isActive);
                    tab.btn.classList.toggle('dark:border-gray-600', !isActive);
                    tab.panel.style.display = isActive ? 'block' : 'none';
                });

                // Reset status editan teks saat ganti tab
                userHasEditedText = false;

                // Tampilkan/sembunyikan wrapper share link
                shareLinkWrapper.style.display = (tabName === 'multi') ? 'block' : 'none';
                
                // Perbarui data QR
                updateQrData();
            }

            tabs.forEach(tab => {
                tab.btn.addEventListener('click', () => window.setActiveTab(tab.name));
            });
            
            // Set Tab Awal (Logika ini dipindahkan ke bawah)
            // window.setActiveTab('single'); 
            
            // [PERBAIKAN] Logika Cek URL untuk Landing Page
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('data')) {
                // --- Mode Landing Page ---
                try {
                    const data = JSON.parse(decodeURIComponent(atob(urlParams.get('data'))));
                    
                    // Sembunyikan generator, tampilkan landing page
                    generatorHeader.classList.add('hidden');
                    generatorMain.classList.add('hidden');
                    landingPage.classList.remove('hidden');
                    
                    // Isi data
                    const landingLogoContainer = document.getElementById('landing-logo-container');
                    if (data.logo) {
                        const img = document.createElement('img');
                        img.src = data.logo;
                        img.alt = "Logo";
                        img.className = "w-24 h-24 rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-lg";
                        landingLogoContainer.innerHTML = ''; // Kosongkan dulu
                        landingLogoContainer.appendChild(img);
                    } else {
                        landingLogoContainer.innerHTML = ''; // Kosongkan jika tidak ada logo
                    }

                    landingTitle.textContent = data.title || 'My Links';
                    document.title = data.title || 'My Links'; // Update judul tab browser
                    landingLinksContainer.innerHTML = ''; // Kosongkan
                    
                    if (data.links && data.links.length > 0) {
                        data.links.forEach(link => {
                            if (link.label && link.url) {
                                const linkEl = document.createElement('a');
                                linkEl.href = formatUrl(link.url);
                                linkEl.target = "_blank";
                                linkEl.rel = "noopener noreferrer";
                                linkEl.className = "block w-full text-center px-6 py-4 bg-indigo-600 dark:bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 dark:hover:bg-indigo-600 transition-all duration-200 transform hover:scale-105";
                                linkEl.textContent = link.label;
                                landingLinksContainer.appendChild(linkEl);
                            }
                        });
                    } else {
                        landingLinksContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No links found.</p>`;
                    }
                    
                    // Setel bahasa footer
                    const savedLang = localStorage.getItem('lang') || 'en';
                    currentLang = savedLang;
                    document.documentElement.lang = savedLang;
                    document.querySelector('[data-lang="footerCreate"]').textContent = translations[savedLang].footerCreate;

                } catch (e) {
                    console.error('Failed to parse URL data:', e);
                    // Jika data rusak, tampilkan generator
                    window.setActiveTab('single');
                }
            } else {
                // --- Mode Generator (Normal) ---
                window.setActiveTab('single');
            }
                
            // Listener untuk semua input data (kecuali yang dinamis)
            singleUrlInput.addEventListener('input', updateQrData);
            multiTitleInput.addEventListener('input', updateQrData);
            whatsappNumber.addEventListener('input', updateQrData);
            Object.values(vcardInputs).forEach(input => {
                if (typeof input === 'object' && input.nodeName !== 'INPUT' && input.nodeName !== 'TEXTAREA') {
                    Object.values(input).forEach(subInput => subInput.addEventListener('input', updateQrData));
                } else {
                    input.addEventListener('input', updateQrData);
                }
            });

            // Listener untuk Teks Kustom
            customTextInput.addEventListener('input', (e) => {
                customText = e.target.value;
                userHasEditedText = true; // User sudah mengedit!
                generateOverlayImage();
            });
            customTextColorInput.addEventListener('input', (e) => {
                customTextColor = e.target.value;
                generateOverlayImage(); // Langsung update
            });
            textRemoveBtn.addEventListener('click', () => {
                customText = '';
                customTextInput.value = '';
                userHasEditedText = false; // Reset status, default akan diisi lagi
                updateQrData(); // Panggil updateQrData untuk mengisi default & regenerasi
            });


            // [PERBAIKAN] Listener Kustomisasi Terpusat
            const styleControls = [
                colorDots, colorBg, colorCornerSquare, colorCornerDot,
                styleDots, styleCornerSquare, styleCornerDot
            ];
            
            const updateAllStyles = () => {
                qrCodeInstance.update({
                    dotsOptions: { color: colorDots.value, type: styleDots.value },
                    backgroundOptions: { color: colorBg.value },
                    cornersSquareOptions: { color: colorCornerSquare.value, type: styleCornerSquare.value },
                    cornersDotOptions: { color: colorCornerDot.value, type: styleCornerDot.value }
                });
                generateOverlayImage(); // Panggil ini untuk memastikan logo/teks di-update juga
            };

            styleControls.forEach(control => control.addEventListener('input', updateAllStyles));

            // Listener Logo
            logoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    logoImage = new Image();
                    logoImage.crossOrigin = "anonymous"; 
                    logoImage.onload = () => {
                        generateOverlayImage(); 
                    };
                    logoImage.onerror = () => {
                        console.error("Failed to load logo");
                        logoImage = null;
                        generateOverlayImage();
                    };
                    logoImage.src = event.target.result; 
                };
                reader.readAsDataURL(file);
            });
            logoRemove.addEventListener('click', () => {
                logoImage = null;
                logoUpload.value = '';
                generateOverlayImage(); 
            });
            
            // Listener Download
            downloadPngBtn.addEventListener('click', () => qrCodeInstance.download({ name: 'qr-code', extension: 'png' }));
            downloadSvgBtn.addEventListener('click', () => qrCodeInstance.download({ name: 'qr-code', extension: 'svg' }));

            // Listener Copy Link
            copyLinkBtn.addEventListener('click', () => {
                shareLinkInput.select();
                try {
                    document.execCommand('copy');
                    const copyText = copyLinkBtn.querySelector('#copy-link-text');
                    const originalText = copyText.textContent;
                    copyText.textContent = translations[currentLang].copied;
                    copyLinkBtn.querySelector('i').setAttribute('data-lucide', 'check');
                    lucide.createIcons();
                    
                    setTimeout(() => {
                        copyText.textContent = originalText;
                        copyLinkBtn.querySelector('i').setAttribute('data-lucide', 'copy');
                        lucide.createIcons();
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy link: ', err);
                }
            });

            // --- Listener Input Dinamis ---
            // Multi Link
            multiPreviewBtn.addEventListener('click', showPreview);
            multiAddLinkBtn.addEventListener('click', () => {
                multiLinksData.push({ label: '', url: '' });
                window.renderMultiLinksList();
                updateQrData();
            });
            multiLinksContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('multi-link-input')) {
                    const index = e.target.dataset.index;
                    const field = e.target.dataset.field;
                    multiLinksData[index][field] = e.target.value;
                    updateQrData();
                }
            });
            multiLinksContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.multi-link-remove');
                if (removeBtn) {
                    multiLinksData.splice(removeBtn.dataset.index, 1);
                    window.renderMultiLinksList();
                    updateQrData();
                }
            });

            // vCard Custom Fields
            vcardAddFieldBtn.addEventListener('click', () => {
                vcardCustomFields.push({ label: '', value: '' });
                window.renderVcardCustomFields();
                updateQrData();
            });
            vcardFieldsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('vcard-field-input')) {
                    vcardCustomFields[e.target.dataset.index][e.target.dataset.field] = e.target.value;
                    updateQrData();
                }
            });
            vcardFieldsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.vcard-field-remove');
                if (removeBtn) {
                    vcardCustomFields.splice(removeBtn.dataset.index, 1);
                    window.renderVcardCustomFields();
                    updateQrData();
                }
            });

            // vCard Custom Socials
            vcardAddSocialBtn.addEventListener('click', () => {
                vcardCustomSocials.push({ label: '', value: '' });
                window.renderVcardCustomSocials();
                updateQrData();
            });
            vcardSocialsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('vcard-social-input')) {
                    vcardCustomSocials[e.target.dataset.index][e.target.dataset.field] = e.target.value;
                    updateQrData();
                }
            });
            vcardSocialsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.vcard-social-remove');
                if (removeBtn) {
                    vcardCustomSocials.splice(removeBtn.dataset.index, 1);
                    window.renderVcardCustomSocials();
                    updateQrData();
                }
            });

            // --- Listener Modal History ---
            historyBtn.addEventListener('click', () => {
                showHistory(); 
                historyModal.classList.remove('hidden');
            });
            closeHistoryModal.addEventListener('click', () => {
                historyModal.classList.add('hidden');
            });
            historyModal.addEventListener('click', (e) => {
                if (e.target === historyModal) {
                    historyModal.classList.add('hidden');
                }
            });

            // --- Listener Modal Preview ---
            closePreviewModal.addEventListener('click', () => {
                previewModal.classList.add('hidden');
            });
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal) {
                    previewModal.classList.add('hidden');
                }
            });
            
            // --- Listener Modal Save ---
            saveCodeBtn.addEventListener('click', () => saveQRCode()); // Ini memicu modal
            
            confirmSaveBtn.addEventListener('click', executeSave); // Ini menjalankan save
            
            const closeModalAndClear = () => {
                saveModal.classList.add('hidden');
                pendingSaveConfig = null; // Batalkan save
            };
            cancelSaveBtn.addEventListener('click', closeModalAndClear);
            closeSaveModal.addEventListener('click', closeModalAndClear);

            // Simpan dengan tombol Enter di input
            saveNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    executeSave();
                }
            });

            // Ganti semua ikon
            lucide.createIcons();
        }

        function showPreview() {
            // Bangun ulang konten pratinjau dari data saat ini
            previewContent.innerHTML = ''; // Kosongkan dulu

            const pageWrapper = document.createElement('div');
            pageWrapper.className = 'w-full max-w-md mx-auto';

            let logoHTML = '';
            if (logoImage && logoImage.src) {
                logoHTML = `
                    <div class="mb-6 flex justify-center">
                        <img src="${logoImage.src}" alt="Logo" class="w-24 h-24 rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-lg">
                    </div>`;
            }

            let linksHTML = '';
            if (multiLinksData.length > 0) {
                linksHTML = multiLinksData.map(link => {
                    if (!link.label || !link.url) return '';
                    return `<a href="#" class="block w-full text-center px-6 py-4 bg-indigo-600 dark:bg-indigo-500 text-white font-semibold rounded-lg shadow-md">${link.label}</a>`;
                }).join('');
            } else {
                linksHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No links found.</p>`;
            }

            pageWrapper.innerHTML = `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                    ${logoHTML}
                    <h1 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">${multiTitleInput.value || 'My Links'}</h1>
                    <div class="space-y-4">
                        ${linksHTML}
                    </div>
                </div>`;

            previewContent.appendChild(pageWrapper);
            previewModal.classList.remove('hidden');
        }

        // --- Mulai Aplikasi ---
        window.addEventListener('load', initGenerator);
    </script>

</body>
</html>
